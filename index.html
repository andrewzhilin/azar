<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR Marker Tracking (Production)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  <style>
    body { 
      margin: 0; 
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #debug-panel {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 12px;
      border-radius: 4px;
      font-size: 14px;
      z-index: 10000;
      pointer-events: none;
    }
    .debug-item {
      margin-bottom: 6px;
    }
    #camera-feed {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 120px;
      border: 2px solid rgba(255,255,255,0.5);
      z-index: 10000;
    }
  </style>
</head>
<body>
  <!-- Debug Camera Feed (toggle with 'D' key) -->
  <video id="camera-feed" autoplay muted></video>

  <!-- Debug Panel -->
  <div id="debug-panel">
    <div class="debug-item">🟢 <span id="ar-status">AR System Initializing...</span></div>
    <div class="debug-item">🎯 <span id="marker-status">Marker: Searching</span></div>
    <div class="debug-item">📊 <span id="fps">Performance: -</span></div>
    <div class="debug-item">📂 <span id="file-status">Files: Loading...</span></div>
  </div>

  <!-- AR Scene -->
  <a-scene 
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; antialias: false; precision: medium"
    stats
    arjs="sourceType: webcam; detectionMode: mono; maxDetectionRate: 60; trackingMethod: best; debugUIEnabled: false"
  >
    <!-- NFT Marker -->
    <a-nft
      id="marker"
      type="nft"
      url="./Trackers/CO-qr" 
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      emitevents="true"
    >
      <!-- 3D Content -->
      <a-entity 
        id="content"
        position="0 0.5 0" 
        scale="0.5 0.5 0.5"
        rotation="0 0 0"
      >
        <a-box 
          color="#FF5722" 
          width="1" 
          height="1" 
          depth="1"
          material="shader: flat; opacity: 1.0"
          shadow
        ></a-box>
        <a-entity 
          position="0 0.5 0"
          gltf-model="url(your-model.glb)"
          visible="false"
        ></a-entity>
      </a-entity>
    </a-nft>

    <!-- Camera -->
    <a-entity 
      camera="fov: 60; near: 0.05; far: 100;"
      position="0 0 0"
      look-controls="enabled: false"
    ></a-entity>
  </a-scene>

  <script>
    // ====================
    // Production Setup
    // ====================
    
    // 1. GitHub Pages Path Fix
    const baseUrl = window.location.href.includes('github.io') 
      ? window.location.pathname.split('/').slice(0, 3).join('/')
      : '';
    
    // 2. Debug Elements
    const debug = {
      status: document.getElementById('ar-status'),
      marker: document.getElementById('marker-status'),
      fps: document.getElementById('fps'),
      files: document.getElementById('file-status'),
      cameraFeed: document.getElementById('camera-feed')
    };

    // 3. Verify Marker Files
    const markerFiles = [
      `${baseUrl}/Trackers/CO-qr.fset`,
      `${baseUrl}/Trackers/CO-qr.fset3`,
      `${baseUrl}/Trackers/CO-qr.iset`
    ];

    Promise.all(markerFiles.map(url => fetch(url)))
      .then(responses => {
        const allOk = responses.every(r => r.ok);
        debug.files.textContent = `Files: ${allOk ? '✅ Loaded' : '❌ Missing'}`;
        if (!allOk) console.error('Missing files:', responses);
      });

    // ====================
    // AR Tracking Setup
    // ====================
    
    const scene = document.querySelector('a-scene');
    const marker = document.getElementById('marker');
    const content = document.getElementById('content');

    // 1. Performance Monitoring
    let lastTime = performance.now();
    let frameCount = 0;
    const updateFPS = () => {
      frameCount++;
      const now = performance.now();
      if (now - lastTime >= 1000) {
        debug.fps.textContent = `Performance: ${frameCount} FPS`;
        frameCount = 0;
        lastTime = now;
      }
      requestAnimationFrame(updateFPS);
    };
    updateFPS();

    // 2. Marker Events
    marker.addEventListener('markerFound', (e) => {
      debug.marker.textContent = `Marker: ✅ Detected (${e.detail.visibility.toFixed(2)})`;
      content.object3D.visible = true;
    });

    marker.addEventListener('markerLost', () => {
      debug.marker.textContent = 'Marker: ❌ Lost';
      content.object3D.visible = false;
    });

    // 3. Camera Access
    scene.addEventListener('loaded', () => {
      debug.status.textContent = 'AR System: Ready';
      
      // Get raw camera feed for debugging
      const camera = scene.camera.el;
      const video = camera.getObject3D('camera').children[0];
      debug.cameraFeed.srcObject = video.srcObject;
      
      // Toggle debug camera with 'D' key
      document.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 'd') {
          debug.cameraFeed.style.display = 
            debug.cameraFeed.style.display === 'none' ? 'block' : 'none';
        }
      });
    });

    // 4. Error Handling
    marker.addEventListener('error', (e) => {
      debug.marker.textContent = `Marker: ⚠️ Error (${e.detail.message})`;
      console.error('Marker error:', e.detail);
    });

    // ====================
    // Production Enhancements
    // ====================
    
    // Auto-resize handling
    window.addEventListener('resize', () => {
      scene.style.width = window.innerWidth + 'px';
      scene.style.height = window.innerHeight + 'px';
    });
  </script>
</body>
</html>